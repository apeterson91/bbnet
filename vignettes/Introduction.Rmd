---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{dplyr}
  %\VignetteDepends{ggplot2}
  %\VignetteDepends{rbenvo}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup,message=F,results='hide'}
library(rsstap)
library(rbenvo)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
data("example_benvo")
```

# Introduction and Motivation

The [`rstap` package](https://biostatistics4socialimpact.github.io/rstap) introduced Spatial Temporal Aggregated Predictor or STAP models, as a method by which the effect of [Built Environment](https://en.wikipedia.org/wiki/Built_environment) Features (BEFs) measured as a point pattern could be incorporated into pre-existing regression methods. The `rsstap` package builds on this framework by modifying the way in which the spatial temporal exposure effect is estimated.

# Model Specification

Restricting our attention to only spatial exposure for the following illustrative example, the spatial aggregated predictor both `rstap` and `rsstap` fit models of the following form:

$$
E[g(\mu_i)] = Z_i^{T}\delta + f(\mathcal{D}_i) \tag{1}\\
$$
While link function $g(\cdot)$, univariate mean $\mu_i$ and covariates $Z_i$ for subject $i=1,...,n$ are identified from a typical regression model, the function $f(\mathcal{D})$ novelly represents the $i$th subject's cumulative exposure across space. In `rstap` This was accomplished by incorporating distances, $d$ through a spatial exposure function $f(\mathcal{D}_i) = \sum_{d \in \mathcal{D}_i} \mathcal{K}_s(d,\theta)$ - typically some exponential decay function, like $\exp(-\frac{d}{\theta})$ or $\exp(-(\frac{d}{\theta})^{\eta})$. Unfortunately, estimating this model through typical methods (e.g. MCMC) requires numerous evaluations of the kernel function summed across the, again typically numerous, distances in the set $\mathcal{D}_i$, of subject-BEF distances.

To remedy this situation, the `rsstap` package adopts a regression spline basis representation, $f(d) = \sum_{j=0}^{J} \beta_j\phi_j(d)$, of the spatial exposure effect, removing the kernel and allowing for estimation on a sum of the function of the distances:

$$
E[Y_i] = Z_i^{T}\delta +   \sum_{j=0}^{J}\sum_{d \in \mathcal{D}_i}\beta_j\phi_j(d) \tag{2}
$$

Since the sum across distances, $\sum_{d\in \mathcal{D}_i} \phi_j(d)$ can be done prior to model fitting, standard methods (e.g. a bayesian equivalent to `mgcv::gam`) can be used, dramatically decreasing computational complexity. 

## Illustration



```{r auxiliary,echo=F}
truth <- geom_line(aes(x=x,y=y),
            ## True generating function
            data=tibble(x=seq(from=0,to=1,by=0.01),
                        y=3*pweibull(seq(from=0,to=1,by=0.01),
                                     shape = 5,
                                     scale = .6,
                                     lower.tail = F)),
            color='red')
```

```{r model_fit,message=F,results='hide'}
fit <- sstap_lm(BMI ~ sex + sap(FFR),
                example_benvo)
```


```{r plot_results}
plot(fit) + truth
```

```{r ppcs}
ppc(fit)
```

## Longitudinal Spatio-Temporal example


```{r long_data,echo=F}
data("longitudinal_HFS")
bdf2 <- longitudinal_HFS
```

```{r}
bdf2
```

```{r,results='hide'}
fit <- sstap_lm(BMI ~ sex + stap(HFS) ,benvo = bdf2)
```

```{r,echo=F}
truth <- geom_contour(aes(x=x,y=y),
            ## True generating function
            data=tibble(x=seq(from=0,to=1,by=0.01),
                        y=-1*pweibull(seq(from=0,to=1,by=0.01),
                                     shape = 5,
                                     scale = .6,
                                     lower.tail = F)),
            color='red')
```

```{r,messages=F,warning=F}
plot(fit)
```

```{r}
plot3D(fit)
```


```{r}
ppc(fit)
```
